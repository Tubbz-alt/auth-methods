<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../node_modules/@polymer/test-fixture/test-fixture.js"></script>
    <script src="../node_modules/mocha/mocha.js"></script>
    <script src="../node_modules/chai/chai.js"></script>
    <script src="../node_modules/wct-mocha/wct-mocha.js"></script>

  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <auth-method-oauth2 grant-type="annotated_custom_grant"></auth-method-oauth2>
      </template>
    </test-fixture>

    <script type="module">
    import '../auth-method-oauth2.js';
    import {afterNextRender} from '@polymer/polymer/lib/utils/render-status.js';
    import {AmfLoader} from './amf-loader.js';
    suite('OAuth2 with raml annotation', function() {
      suite('custom auth', () => {
        [
          ['Full data model', false],
          ['Compact data model', true]
        ].forEach((setupItem) => {
          const clientId = '821776164331-rserncqpdsq32lmbf5cfeolgcoujb6fm.apps.googleusercontent.com';
          const authorizationUri = 'https://accounts.google.com/o/oauth2/v2/auth';
          const accessTokenUri = 'https://www.googleapis.com/oauth2/v4/token';
          const clientSecret = 'test-secret';
          const redirectUri = 'https://redirect';
          const scopes = ['email', 'profile'];
          const username = 'test-username';
          const password = 'test-password';

          suite(setupItem[0], function() {
            let amf;
            let security;
            let element;
            suiteSetup(() => {
              return AmfLoader.load(0, setupItem[1])
              .then((model) => {
                amf = model[0];
                security = model[1];
              });
            });

            suite('Basic computations', function() {
              suiteSetup(function() {
                element = fixture('basic');
                element.amfModel = amf;
                element.amfSettings = security;
              });

              test('authQueryParameters is computed', function() {
                assert.typeOf(element.authQueryParameters, 'array');
                assert.lengthOf(element.authQueryParameters, 5);
              });

              test('tokenQueryParameters is computed', function() {
                assert.typeOf(element.tokenQueryParameters, 'array');
                assert.lengthOf(element.tokenQueryParameters, 2);
              });

              test('tokenHeaders is computed', function() {
                assert.typeOf(element.tokenHeaders, 'array');
                assert.lengthOf(element.tokenHeaders, 1);
              });

              test('tokenBody is computed', function() {
                assert.typeOf(element.tokenBody, 'array');
                assert.lengthOf(element.tokenBody, 2);
              });

              test('grantTypes is computed', function() {
                assert.lengthOf(element.grantTypes, 4);
                assert.equal(element.grantTypes[0].type, 'implicit');
                assert.equal(element.grantTypes[1].type, 'authorization_code');
                assert.equal(element.grantTypes[2].type, 'annotated_custom_grant');
                assert.equal(element.grantTypes[3].type, 'annotated_custom_grant2');
              });

              test('grantTypes Has labels', function() {
                assert.lengthOf(element.grantTypes, 4);
                assert.equal(element.grantTypes[0].label, 'Access token (browser flow)');
                assert.equal(element.grantTypes[1].label, 'Authorization code (server flow)');
                assert.equal(element.grantTypes[2].label, 'annotated_custom_grant');
                assert.equal(element.grantTypes[3].label, 'annotated_custom_grant2');
              });
            });

            suite('Forms rendering', function() {
              setup(function(done) {
                sessionStorage.clear();
                element = fixture('basic');
                element.amfModel = amf;
                element.amfSettings = security;

                element.clientId = clientId;
                element.authorizationUri = authorizationUri;
                element.clientSecret = clientSecret;
                element.accessTokenUri = accessTokenUri;
                element.redirectUri = redirectUri;
                element.scopes = scopes;
                element.username = username;
                element.password = password;

                afterNextRender(element, function() {
                  flush(() => done());
                });
              });

              test('Validation is disabled for OAuth regular inputs', function() {
                const inputs = element.shadowRoot.querySelectorAll('paper-input');
                inputs.forEach(function(input) {
                  assert.isFalse(input.required);
                });
              });

              test('Renders authorization query parameters', function() {
                const input = element.shadowRoot.querySelectorAll('[data-type="auth-query"]');
                assert.ok(input);
              });

              test('Renders authorization headers', function() {
                const input = element.shadowRoot.querySelectorAll('[data-type="auth-headers"]');
                assert.ok(input);
              });

              test('Renders token query parameters', function() {
                const input = element.shadowRoot.querySelectorAll('[data-type="token-query"]');
                assert.ok(input);
              });

              test('Renders token headers', function() {
                const input = element.shadowRoot.querySelectorAll('[data-type="token-headers"]');
                assert.ok(input);
              });

              test('Renders token body', function() {
                const input = element.shadowRoot.querySelectorAll('[data-type="token-body"]');
                assert.ok(input);
              });
            });

            suite('getSettings()', function() {
              setup(function(done) {
                sessionStorage.clear();
                element = fixture('basic');
                element.amfModel = amf;
                element.amfSettings = security;

                element.clientId = clientId;
                element.authorizationUri = authorizationUri;
                element.clientSecret = clientSecret;
                element.accessTokenUri = accessTokenUri;
                element.redirectUri = redirectUri;
                element.scopes = scopes;
                element.username = username;
                element.password = password;

                afterNextRender(element, function() {
                  flush(() => done());
                });
              });

              test('Returns an object', function() {
                const result = element.getSettings();
                assert.typeOf(result, 'object');
              });

              test('type is set', function() {
                const result = element.getSettings();
                assert.equal(result.type, element.grantType);
              });

              test('clientId is set', function() {
                const result = element.getSettings();
                assert.equal(result.clientId, clientId);
              });

              test('accessToken is set', function() {
                let result = element.getSettings();
                assert.equal(result.accessToken, '', 'Token value is empty');
                element.accessToken = 'test-token';
                result = element.getSettings();
                assert.equal(result.accessToken, element.accessToken, 'Token value is set');
              });

              test('authorizationUri is set', function() {
                const result = element.getSettings();
                assert.equal(result.authorizationUri, authorizationUri);
              });

              test('redirectUri is set', function() {
                const result = element.getSettings();
                assert.equal(result.redirectUri, redirectUri);
              });

              test('scopes is set', function() {
                const result = element.getSettings();
                assert.isTrue(result.scopes === scopes);
              });

              test('clientSecret is set', function() {
                const result = element.getSettings();
                assert.equal(result.clientSecret, clientSecret);
              });

              test('accessTokenUri is set', function() {
                const result = element.getSettings();
                assert.equal(result.accessTokenUri, accessTokenUri);
              });

              test('username is set', function() {
                const result = element.getSettings();
                assert.equal(result.username, username);
              });

              test('password is set', function() {
                const result = element.getSettings();
                assert.equal(result.password, password);
              });

              test('Custom values are set when required', function() {
                const result = element.getSettings();
                assert.equal(result.customData.auth.parameters[0].name, 'resource');
                assert.equal(result.customData.auth.parameters[0].value, 'default');
              });

              test('Authorization query param is set', function() {
                const value = 'test-aq';
                element.authQueryParameters[0].value = value;
                const result = element.getSettings();
                assert.equal(result.customData.auth.parameters[0].value, value);
              });

              test('Custom value has name and value', function() {
                const value = 'test-aq';
                element.set('authQueryParameters.4.value', value);
                const result = element.getSettings();
                assert.equal(result.customData.auth.parameters[0].name, 'resource');
                assert.equal(result.customData.auth.parameters[0].value, value);
              });

              test('Custom values are not set when not required', function() {
                const result = element.getSettings();
                assert.isUndefined(result.customData.auth.headers);
              });

              test('Token query param is set', function() {
                const value = 'test-tq';
                element.tokenQueryParameters[0].value = value;
                const result = element.getSettings();
                assert.equal(result.customData.token.parameters[0].value, value);
              });

              test('Token header is set', function() {
                const value = 'test-th';
                element.tokenHeaders[0].value = value;
                const result = element.getSettings();
                assert.equal(result.customData.token.headers[0].value, value);
              });

              test('Token body is set', function() {
                const value = 'test-tb';
                element.tokenBody[0].value = value;
                const result = element.getSettings();
                assert.equal(result.customData.token.body[0].value, value);
              });
            });
          });
        });
      });
    });
    </script>
  </body>
</html>
