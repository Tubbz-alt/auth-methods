<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>
    <link rel="import" href="../auth-methods.html">
  </head>
  <body>
    <test-fixture id="code">
      <template>
        <auth-method-oauth2 grant-type="authorization_code"></auth-method-oauth2>
      </template>
    </test-fixture>
    <script>
    /* global fixture, assert, MockInteractions, sinon, TestHelpers */
    suite('Password grant type', function() {
      var element;
      var clientId = '821776164331-rserncqpdsq32lmbf5cfeolgcoujb6fm.apps.googleusercontent.com';
      var authUrl = 'https://accounts.google.com/o/oauth2/v2/auth';
      var accessTokenUrl = 'https://www.googleapis.com/oauth2/v4/token';
      var clientSecret = 'test-secret';
      var redirectUrl = 'https://redirect';
      var scopes = ['email', 'profile'];

      suite('Basics', function() {
        setup(function(done) {
          element = fixture('code');
          element.clientId = clientId;
          element.authUrl = authUrl;
          element.clientSecret = clientSecret;
          element.accessTokenUrl = accessTokenUrl;
          element.redirectUrl = redirectUrl;
          element.scopes = scopes;
          Polymer.RenderStatus.afterNextRender(this, function() {
            TestHelpers.forceXIfStamp(element);
            done();
          });
        });

        test('Settings are set', function() {
          var settings = element.settings;
          assert.equal(settings.type, 'authorization_code');
          assert.equal(settings.clientId, clientId);
          assert.equal(settings.authorizationUrl, authUrl);
          assert.equal(settings.clientSecret, clientSecret);
          assert.equal(settings.accessTokenUrl, accessTokenUrl);
          assert.deepEqual(settings.scopes, scopes);
          assert.equal(settings.redirectUrl, redirectUrl);
        });

        test('Should accept RAML settings', function() {
          var aUrl = 'http://domain.com/authorizationUri';
          var aUrl2 = 'http://domain.com/accessTokenUri';
          var type = ['code', 'implicit'];
          var scopes = ['test-1', 'test2'];
          var raml = {
            settings: {
              authorizationGrants: type,
              authorizationUri: aUrl,
              accessTokenUri: aUrl2,
              scopes: scopes
            }
          };
          element.ramlSettings = raml;
          TestHelpers.forceXIfStamp(element);
          assert.equal(element.grantType, 'authorization_code');
          assert.equal(element.authUrl, aUrl);
          assert.deepEqual(element.scopes, scopes);
          assert.equal(element.accessTokenUrl, aUrl2);
        });
      });

      suite('Validation', function() {
        setup(function(done) {
          element = fixture('code');
          element.clientId = clientId;
          element.authUrl = authUrl;
          element.clientSecret = clientSecret;
          element.accessTokenUrl = accessTokenUrl;
          element.redirectUrl = redirectUrl;
          element.scopes = scopes;
          Polymer.RenderStatus.afterNextRender(this, function() {
            TestHelpers.forceXIfStamp(element);
            done();
          });
        });

        test('Should not be validated', function() {
          element.accessTokenUrl = undefined;
          assert.isFalse(element.validate(), 'Active validation.');
        });

        test('Should be validated', function() {
          element.scopes = ['email', 'profile'];
          TestHelpers.forceXIfStamp(element);
          assert.isTrue(element.validate(), 'Active validation.');
          assert.isTrue(element.validate(true), 'Passive validation.');
        });

        test('Should not fire oauth2-token-requested event', function() {
          var spy = sinon.stub();
          element.accessTokenUrl = undefined;
          element.addEventListener('oauth2-token-requested', spy);
          var button = Polymer.dom(element.root).querySelector('.auth-button');
          MockInteractions.tap(button);
          assert.isFalse(spy.calledOnce);
        });

        test('Fire oauth2-token-requested event', function() {
          element.scopes = ['email', 'profile'];
          TestHelpers.forceXIfStamp(element);
          var spy = sinon.stub();
          element.addEventListener('oauth2-token-requested', spy);
          var button = Polymer.dom(element.root).querySelector('.auth-button');
          MockInteractions.tap(button);
          assert.isTrue(spy.calledOnce);
        });
      });

      suite('Events', function() {
        setup(function(done) {
          element = fixture('code');
          element.clientId = clientId;
          element.authUrl = authUrl;
          element.clientSecret = clientSecret;
          element.accessTokenUrl = accessTokenUrl;
          element.redirectUrl = redirectUrl;
          element.scopes = scopes;
          Polymer.RenderStatus.afterNextRender(this, function() {
            TestHelpers.forceXIfStamp(element);
            done();
          });
        });

        test('oauth2-token-requested event contains state parameter', function() {
          var eventData;
          element.addEventListener('oauth2-token-requested', function clb(e) {
            element.removeEventListener('oauth2-token-requested', clb);
            eventData = e.detail;
          });
          var button = Polymer.dom(element.root).querySelector('.auth-button');
          MockInteractions.tap(button);
          assert.typeOf(eventData.state, 'string');
        });

        test('oauth2-token-requested event contains all required data', function(done) {
          element.addEventListener('oauth2-token-requested', function clb(e) {
            element.removeEventListener('oauth2-token-requested', clb);
            assert.equal(e.detail.type, 'authorization_code', 'type is set');
            assert.equal(e.detail.clientId, clientId, 'clientId is set');
            assert.equal(e.detail.clientSecret, clientSecret, 'clientSecret is set');
            assert.equal(e.detail.accessTokenUrl, accessTokenUrl, 'accessTokenUrl is set');
            assert.equal(e.detail.tokenValue, '', 'tokenValue is empty');
            assert.typeOf(e.detail.customData, 'object', 'customData is set');
            assert.equal(e.detail.authorizationUrl, authUrl, 'authorizationUrl is set');
            assert.equal(e.detail.redirectUrl, redirectUrl, 'redirectUrl is set');
            assert.typeOf(e.detail.scopes, 'array', 'scopes is set');
            done();
          });
          element.authorize();
        });
      });

      suite('_getSettings()', function() {
        var element;
        setup(function() {
          element = fixture('code');
          element.clientId = clientId;
          element.authUrl = authUrl;
          element.redirectUrl = redirectUrl;
          element.scopes = scopes;
          element.clientSecret = clientSecret;
          element.accessTokenUrl = accessTokenUrl;
        });

        test('Returns an object', function() {
          var result = element._getSettings();
          assert.typeOf(result, 'object');
        });

        test('type is set', function() {
          var result = element._getSettings();
          assert.equal(result.type, element.grantType);
        });

        test('clientId is set', function() {
          var result = element._getSettings();
          assert.equal(result.clientId, clientId);
        });

        test('tokenValue is set', function() {
          var result = element._getSettings();
          assert.equal(result.tokenValue, '', 'Token value is empty');

          element.tokenValue = 'test-token';
          result = element._getSettings();
          assert.equal(result.tokenValue, element.tokenValue, 'Token value is set');
        });

        test('authorizationUrl is set', function() {
          var result = element._getSettings();
          assert.equal(result.authorizationUrl, authUrl);
        });

        test('redirectUrl is set', function() {
          var result = element._getSettings();
          assert.equal(result.redirectUrl, redirectUrl);
        });

        test('scopes is set', function() {
          var result = element._getSettings();
          assert.isTrue(result.scopes === scopes);
        });

        test('clientSecret is set', function() {
          var result = element._getSettings();
          assert.equal(result.clientSecret, clientSecret);
        });

        test('accessTokenUrl is set', function() {
          var result = element._getSettings();
          assert.equal(result.accessTokenUrl, accessTokenUrl);
        });
      });
    });

    </script>
  </body>
</html>
