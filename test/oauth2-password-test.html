<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>
    <link rel="import" href="../auth-methods.html">
  </head>
  <body>
    <test-fixture id="password">
      <template>
        <auth-method-oauth2 grant-type="password"></auth-method-oauth2>
      </template>
    </test-fixture>
    <script>
    /* global fixture, assert, MockInteractions, sinon, TestHelpers */
    suite('Code grant type', function() {
      var element;
      var clientId = '821776164331-rserncqpdsq32lmbf5cfeolgcoujb6fm.apps.googleusercontent.com';
      var authUrl = 'https://accounts.google.com/o/oauth2/v2/auth';
      var username = 'test-username';
      var password = 'test-password';

      suite('Basics', function() {
        setup(function(done) {
          element = fixture('password');
          element.clientId = clientId;
          element.accessTokenUrl = authUrl;
          element.username = username;
          element.password = password;
          Polymer.RenderStatus.afterNextRender(this, function() {
            TestHelpers.forceXIfStamp(element);
            done();
          });
        });

        test('Settings are set', function() {
          var settings = element.settings;
          assert.equal(settings.type, 'password');
          assert.equal(settings.clientId, clientId);
          assert.equal(settings.accessTokenUrl, authUrl);
          assert.equal(settings.username, username);
          assert.equal(settings.password, password);
        });

        test('Should accept RAML settings', function() {
          var authUrl = 'https://raml-url';
          var type = ['password', 'implicit'];
          var raml = {
            settings: {
              authorizationGrants: type,
              accessTokenUri: authUrl
            }
          };
          element.ramlSettings = raml;
          TestHelpers.forceXIfStamp(element);
          assert.equal(element.grantType, 'password');
          assert.equal(element.accessTokenUrl, authUrl);
          assert.equal(element.username, username);
          assert.equal(element.password, password);
        });
      });

      suite('Validation', function() {
        setup(function(done) {
          element = fixture('password');
          element.accessTokenUrl = authUrl;
          element.clientId = clientId;
          element.username = username;
          Polymer.RenderStatus.afterNextRender(this, function() {
            TestHelpers.forceXIfStamp(element);
            done();
          });
        });

        test('Should not be validated', function() {
          assert.isFalse(element.validate(), 'Active validation.');
        });

        test('Should be validated', function() {
          element.password = password;
          assert.isTrue(element.validate());
        });

        test('Should not fire oauth2-token-requested event', function() {
          var spy = sinon.stub();
          element.accessTokenUrl = undefined;
          element.addEventListener('oauth2-token-requested', spy);
          var button = Polymer.dom(element.root).querySelector('.auth-button');
          MockInteractions.tap(button);
          assert.isFalse(spy.calledOnce);
        });

        test('Fire oauth2-token-requested event', function() {
          element.password = password;
          var spy = sinon.stub();
          element.addEventListener('oauth2-token-requested', spy);
          var button = Polymer.dom(element.root).querySelector('.auth-button');
          MockInteractions.tap(button);
          assert.isTrue(spy.calledOnce);
        });
      });

      suite('Events', function() {
        setup(function(done) {
          element = fixture('password');
          element.clientId = clientId;
          element.accessTokenUrl = authUrl;
          element.username = username;
          element.password = password;
          Polymer.RenderStatus.afterNextRender(this, function() {
            TestHelpers.forceXIfStamp(element);
            done();
          });
        });

        test('oauth2-token-requested event contains state parameter', function() {
          var eventData;
          element.addEventListener('oauth2-token-requested', function clb(e) {
            element.removeEventListener('oauth2-token-requested', clb);
            eventData = e.detail;
          });
          var button = Polymer.dom(element.root).querySelector('.auth-button');
          MockInteractions.tap(button);
          assert.typeOf(eventData.state, 'string');
        });

        test('oauth2-token-requested event contains all required data', function(done) {
          element.addEventListener('oauth2-token-requested', function clb(e) {
            element.removeEventListener('oauth2-token-requested', clb);
            assert.equal(e.detail.type, 'password', 'type is set');
            assert.equal(e.detail.accessTokenUrl, authUrl, 'accessTokenUrl is set');
            assert.equal(e.detail.clientId, clientId, 'clientId is set');
            assert.equal(e.detail.username, username, 'username is set');
            assert.equal(e.detail.password, password, 'password is set');
            assert.typeOf(e.detail.customData, 'object', 'customData is set');
            done();
          });
          element.authorize();
        });
      });

      suite('_getSettings()', function() {
        var element;
        setup(function() {
          element = fixture('password');
          element.clientId = clientId;
          element.accessTokenUrl = authUrl;
          element.username = username;
          element.password = password;
        });

        test('Returns an object', function() {
          var result = element._getSettings();
          assert.typeOf(result, 'object');
        });

        test('type is set', function() {
          var result = element._getSettings();
          assert.equal(result.type, element.grantType);
        });

        test('clientId is set', function() {
          var result = element._getSettings();
          assert.equal(result.clientId, clientId);
        });

        test('tokenValue is set', function() {
          var result = element._getSettings();
          assert.equal(result.tokenValue, '', 'Token value is empty');

          element.tokenValue = 'test-token';
          result = element._getSettings();
          assert.equal(result.tokenValue, element.tokenValue, 'Token value is set');
        });

        test('accessTokenUrl is set', function() {
          var result = element._getSettings();
          assert.equal(result.accessTokenUrl, authUrl);
        });

        test('username is set', function() {
          var result = element._getSettings();
          assert.equal(result.username, username);
        });

        test('password is set', function() {
          var result = element._getSettings();
          assert.equal(result.password, password);
        });
      });
    });

    </script>
  </body>
</html>
