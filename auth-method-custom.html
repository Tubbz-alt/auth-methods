<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../events-target-behavior/events-target-behavior.html">
<link rel="import" href="../paper-masked-input/paper-masked-input.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../markdown-styles/markdown-styles.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../api-view-model-transformer/api-view-model-transformer.html">
<link rel="import" href="../api-property-form-item/api-property-form-item.html">
<link rel="import" href="auth-methods-mixin.html">
<link rel="import" href="auth-methods-styles.html">
<link rel="import" href="auth-method-step.html">
<!--
The `<auth-method-custom>` element displays a form to provide the authorization details for RAML's
custom security scheme.

This element works differently than other authorization panels because it sends
`request-header-changed` and `query-parameter-changed` custom events directly and it doesn't
care if it's wrapped with the `authorization-panel` element that will handle this.
This element will also listen for this events and if the application uses other ARC elements
that use this events to communicate (like `raml-request-panel`) then the value for headers or query
parameters will be updated when event occur.

Besides events listed above it will also fire the `auth-settings-changed` custom event as other
authorization methods.

This element will rended empty if `ramlSettings` property is not set or is empty.
Parent element should check if `securedBy` property of RAML method contains values.

### Example
```
<auth-method-custom raml-settings="{...}"></auth-method-custom>
```

### Styling
`<auth-methods>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--auth-method-custom` | Mixin applied to the element. | `{}`
`--auth-method-panel` | Mixin applied to all auth elements. | `{}`
`--inline-help-icon-color` | Color of the icon button to display help | `rgba(0, 0, 0, 0.24)`
`--inline-help-icon-color-hover` | Color of the icon button to display help when hovered | `--accent-color` or `rgba(0, 0, 0, 0.74)`
`--raml-headers-form-input-label-color` | Color of the lable of the `paper-input` element. | `rgba(0, 0, 0, 0.48)`
`raml-headers-form-input-label-color-required` | Color of the lable of the `paper-input` element when it's required. | `rgba(0, 0, 0, 0.72)`

Input styles are consistent with `raml-headers-form` element.

@group UI Elements
@element auth-method-custom
@demo demo/custom.html
-->
<dom-module id="auth-method-custom">
  <template strip-whitespace>
    <style include="markdown-styles"></style>
    <style include="auth-methods-styles">
    :host {
      display: block;
      @apply --auth-method-panel;
      @apply --auth-method-custom;

      --paper-icon-button: {
        color: var(--hint-trigger-color, rgba(0, 0, 0, 0.74));
        transition: color 0.25s linear;
        @apply --icon-button;
      }

      --paper-icon-button-hover: {
        color: var(--hint-trigger-hover-color, rgba(0, 0, 0, 0.88));
        @apply --icon-button-hover;
      }
    }

    .field-value {
      @apply --layout-horizontal;
      @apply --layout-flex;
    }

    api-property-form-item {
      @apply --layout-flex;
    }

    .header-item,
    .param-item {
      width: 100%;
    }

    .data-docs {
      @apply --arc-font-common-base;
      font-size: 13px !important;
      font-weight: 200;
      line-height: 24px;
      color: var(--inline-documentation-color, rgba(0, 0, 0, 0.87));
    }

    .help-icon {
      margin-top: 16px;
    }
    </style>
    <auth-method-step step-start-index="[[stepStartIndex]]" step="1" no-steps="[[noSteps]]">
      <span slot="title">Set authorization data</span>
      <section>
        <iron-form>
          <form autocomplete="on">
            <template is="dom-if" if="[[hasHeaders]]">
              <section>
                <template is="dom-repeat" items="{{headers}}"  data-repeater="header">
                  <div class="header-item">
                    <div class="field-value">
                      <api-property-form-item model="[[item]]" name="[[item.name]]" value="{{item.value}}" data-type="header"></api-property-form-item>
                      <template is="dom-if" if="[[item.hasDescription]]">
                        <paper-icon-button class="help-icon" icon="arc:help" on-tap="_toggleDocumentation" data-source="header" title="Display documentation" noink="[[noink]]"></paper-icon-button>
                      </template>
                    </div>
                    <div class="data-docs" data-source="header" data-key$="[[item.name]]"></div>
                  </div>
                </template>
              </section>
            </template>
            <template is="dom-if" if="[[hasQueryParameters]]">
              <section>
                <template is="dom-repeat" items="{{queryParameters}}" data-repeater="query">
                  <div class="param-item">
                    <div class="field-value">
                      <api-property-form-item model="[[item]]" name="[[item.name]]" value="{{item.value}}" data-type="query"></api-property-form-item>
                      <template is="dom-if" if="[[item.hasDescription]]">
                        <paper-icon-button class="help-icon" icon="arc:help" on-tap="_toggleDocumentation" data-source="query" title="Display documentation" noink="[[noink]]"></paper-icon-button>
                      </template>
                    </div>
                    <div class="data-docs" data-source="query" data-key$="[[item.name]]"></div>
                  </div>
                </template>
              </section>
            </template>
          </form>
        </iron-form>
      </section>
    </auth-method-step>
  </template>
  <script>
  /**
   *
   * ## Changes in version 2
   *
   * - The element now works with AMF json/ld data model. RAML json parser output
   * is no longer supported.
   * - `ramlSettings` has been renamed to `securityScheme`
   *
   * @customElement
   * @polymer
   * @memberof UiElements
   * @appliesMixin ArcBehaviors.EventsTargetBehavior
   * @appliesMixin ArcBehaviors.AuthMethodsMixin
   * @demo demo/custom.html
   */
  class AuthMethodCustom extends ArcBehaviors.AuthMethodsMixin(ArcBehaviors.EventsTargetBehavior(Polymer.Element)) {
    static get is() { return 'auth-method-custom'; }
    static get properties() {
      return {
        /**
         * AMF security scheme model.
         */
        securityScheme: {
          type: Object,
          observer: '_schemeChanged'
        },
        /**
         * Computed list of headers to render in the form.
         */
        headers: {
          type: Array,
          readOnly: true
        },
        /**
         * Computed list of query parameters to render.
         */
        queryParameters: {
          type: Array,
          readOnly: true
        },
        // Computed value, true if headers are defined in RAML settings.
        hasHeaders: {
          type: Boolean,
          computed: '_computeHasData(headers)'
        },
        // Computed value, true if query parameters are defined in RAML settings.
        hasQueryParameters: {
          type: Boolean,
          computed: '_computeHasData(queryParameters)'
        },
        /**
         * Name of the security scheme
         */
        schemeName: {
          type: String,
          readOnly: true
        },
        /**
         * Security scheme description
         */
        schemeDescription: {
          type: String,
          readOnly: true
        }
      };
    }

    static get observers() {
      return [
        '_settingsChanged(headers.*)',
        '_settingsChanged(queryParameters.*)'
      ];
    }

    constructor() {
      super();
      this._headerChangedHandler = this._headerChangedHandler.bind(this);
      this._parameterChangedHandler = this._parameterChangedHandler.bind(this);
    }

    _attachListeners(node) {
      node.addEventListener('request-header-changed', this._headerChangedHandler);
      node.addEventListener('query-parameter-changed', this._parameterChangedHandler);
    }

    _detachListeners(node) {
      node.removeEventListener('request-header-changed', this._headerChangedHandler);
      node.removeEventListener('query-parameter-changed', this._parameterChangedHandler);
    }
    /**
     * Validates the form.
     *
     * @return {Boolean} `true` if valid, `false` otherwise.
     */
    validate() {
      const form = this.shadowRoot.querySelector('iron-form');
      return form.validate();
    }

    _schemeChanged(model) {
      this.headers = undefined;
      this.queryParameters = undefined;
      this._clearDocs();
      if (!model || !model['@type'] || !model['@type'].length) {
        return;
      }
      const isSecurity = model['@type']
        .indexOf('http://raml.org/vocabularies/security#SecurityScheme') !== -1;
      if (!isSecurity) {
        return;
      }
      const type = model['http://raml.org/vocabularies/security#type'];
      const isCustom = type && type[0] && type[0]['@value'] === 'x-custom';
      if (!isCustom) {
        return;
      }
      const prefix = 'http://raml.org/vocabularies/http#';
      this._createViewModel('header', model[prefix + 'header']);
      this._createViewModel('parameter', model[prefix + 'parameter']);
      this._setSchemeName(this._getAmfValue(model[prefix + 'name']));
      this._setSchemeDescription(this._getAmfValue(model['http://schema.org/description']));
    }
    /**
     * Generates view model using the tranformer.
     *
     * @param {String} type Param type. Either `header` or `parameter`.
     * @param {Array} model
     * @return {Promise}
     */
    _createViewModel(type, model) {
      if (!model) {
        return;
      }
      const factory = document.createElement('api-view-model-transformer');
      return factory.computeViewModel(model)
      .then((data) => {
        if (!data) {
          return;
        }
        if (type === 'header') {
          this._setHeaders(data);
        } else if (type === 'parameter') {
          this._setQueryParameters(data);
        }
      });
    }

    _computeHasData(data) {
      return !!(data && data.length);
    }

    _settingsChanged() {
      if (!this.shadowRoot || this.__cancelChangeEvent) {
        return;
      }
      this.notifySettingsChanged();
    }
    /**
     * Returns current configuration of the OAuth2.
     *
     * @return {Object} Current OAuth2 configuration.
     */
    getSettings() {
      const form = this.shadowRoot.querySelector('iron-form');
      return form.serializeForm();
    }
    /**
     * Restores settings from stored value.
     * For custom methods this is dummy function.
     */
    restore() {}

    notifySettingsChanged() {
      const detail = {
        settings: this.getSettings(),
        type: 'x-custom',
        name: this.shemeName,
        valid: this.validate()
      };
      this.dispatchEvent(new CustomEvent('auth-settings-changed', {
        detail: detail,
        bubbles: true,
        composed: true
      }));
    }

    /**
     * When header value changes then it will file the `request-header-changed` to inform other
     * observers about this event.
     */
    _headerValueChanged(e) {
      var item = e.model.get('item');
      var name = item.name || item.key;
      var value = item.value;
      this.fire('request-header-changed', {
        name: name,
        value: value
      });
      this.notifySettingsChanged();
    }

    // Opens the documentation for headers item.
    _openHeaderDoc(e) {
      var model = this._getItemModel('headers', e);
      this._toggleDoc('headers', model);
    }
    // Opens the documentation for query parameters item.
    _openParamDoc(e) {
      var model = this._getItemModel('params', e);
      this._toggleDoc('params', model);
    }
    /**
     * Returns model for event fired by a repeater defined as the `source`
     */
    _getItemModel(source, e) {
      var template = this.$.form.querySelector('[' + source + '-repeater]');
      return template.modelForElement(e.target);
    }

    _toggleDoc(type, model) {
      var i = model.index + 1;
      var collapse = this.$$('#' + type + 'List')
        .querySelector('.input-row:nth-child(' + i + ') iron-collapse');
      if (!collapse) {
        return;
      }
      collapse.opened = !collapse.opened;
    }
    /**
     * When query parameter value changes then it will file the `query-parameter-changed` custom
     * event to inform other observers about this event.
     */
    _parameterValueChanged(e) {
      var item = e.model.get('item');
      var name = item.name || item.key;
      var value = item.value;
      this.fire('query-parameter-changed', {
        name: name,
        value: value
      });
      this.notifySettingsChanged();
    }

    /**
     * Handler for the `request-header-changed` event.
     * It updates value for a single header if this header is already on the list.
     */
    _headerChangedHandler(e) {
      this._updateEventValue('headers', e);
    }

    /**
     * Handler for the `query-parameter-changed` event.
     * It updates value for a single parameter if this parameter is already on the list.
     */
    _parameterChangedHandler(e) {
      this._updateEventValue('queryParameters', e);
    }
    /**
     * Update array value for given type (`headers` or `queryParameters`) for given event.
     */
    _updateEventValue(target, e) {
      if (e.target === this || !this._isOpened || e.defaultPrevented) {
        return;
      }
      var name = e.detail.name;
      if (!name) {
        return;
      }
      // Headers are case insensitive.
      name = target === 'headers' ? name.toLowerCase() : name;
      var parameters = this[target];
      if (!parameters || !parameters.length) {
        return;
      }
      for (var i = 0, len = parameters.length; i < len; i++) {
        var paramName = parameters[i].name || parameters[i].key;
        if (!paramName) {
          continue;
        }
        paramName = target === 'headers' ? paramName.toLowerCase() : paramName;
        if (paramName === name) {
          this.set([target, i, 'value'], e.detail.value);
          return;
        }
      }
    }
    /**
     * Toggles documentartion for custom property.
     *
     * @param {CustomEvent} e
     */
    _toggleDocumentation(e) {
      const target = e.target;
      const source = target.dataset.source;
      if (!source) {
        throw new Error('Could not find source of the event.');
      }
      const repeater = this.shadowRoot.querySelector('[data-repeater="' + source + '"]');
      if (!repeater) {
        throw new Error('Could not find repeater for the item.');
      }
      const model = repeater.modelForElement(target).get('item');
      let selector = '.data-docs[data-source="' + source + '"]';
      selector += '[data-key="' + model.name + '"]';
      const docsContainer = this.shadowRoot.querySelector(selector);
      if (!docsContainer) {
        throw new Error('Could not find documentation container.');
      }
      if (!docsContainer.children[0]) {
        this._createDocsElements(model, docsContainer);
      } else {
        docsContainer.children[0].opened = !docsContainer.children[0].opened;
      }
    }
    /**
     * Creates a documentation element.
     *
     * @param {Object} model
     * @param {Object} appendTo
     */
    _createDocsElements(model, appendTo) {
      const collapse = document.createElement('iron-collapse');
      const marked = document.createElement('marked-element');
      const wrapper = document.createElement('div');

      collapse.dataset.docsCollapse = true;
      wrapper.className = 'markdown-html markdown-body';
      marked.appendChild(wrapper);
      collapse.appendChild(marked);
      appendTo.appendChild(collapse);

      marked.markdown = model.description;
      Polymer.RenderStatus.afterNextRender(this, () => {
        collapse.opened = true;
      });
    }
    /**
     * Clears all custom data documention nodes.
     */
    _clearDocs() {
      const nodes = this.shadowRoot.querySelectorAll('[data-docs-collapse="true"]');
      if (!nodes || !nodes.length) {
        return;
      }
      nodes.forEach((node) => node.parentNode.removeChild(node));
    }
    /**
     * Fired when the any of the auth method settings has changed.
     * This event will be fired quite frequently - each time anything in the text field changed.
     * With one exception. This event will not be fired if the validation of the form didn't passed.
     *
     * @event auth-settings-changed
     * @param {Object} settings Current settings containing hash, password
     * and username.
     * @param {String} type The authorization type - basic
     * @param {Boolean} valid True if the form has been validated.
     * @param {String} name Name of the custom method to differeciante them if many.
     */
    /**
     * Fired when the header value has changed.
     *
     * @event request-header-changed
     * @param {String} name Name of the header
     * @param {String} value Value of the header
     */
    /**
     * Fired when the header value has changed.
     *
     * @event query-parameter-changed
     * @param {String} name Name of the parameter
     * @param {String} value Value of the parameter
     */
  }
  window.customElements.define(AuthMethodCustom.is, AuthMethodCustom);
  </script>
</dom-module>
